name: Build Android APK & AAB (Capacitor)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§± Ã‰tape 1 - RÃ©cupÃ©ration du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Ã‰tape 2 - Installer Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ğŸ“¦ Ã‰tape 3 - Installer les dÃ©pendances
      - name: Install dependencies
        run: npm ci

      # ğŸ§‘â€ğŸ³ Ã‰tape 4 - Build du projet web
      - name: Build web app
        run: npm run build

      # âš™ï¸ Ã‰tape 5 - Installer Capacitor Android tools
      - name: Install Capacitor Android tools
        run: |
          npm install @capacitor/cli @capacitor/android --save-dev

      # ğŸ“± Ã‰tape 6 - Ajouter la plateforme Android (si pas dÃ©jÃ  prÃ©sente)
      - name: Add Android platform
        run: npx cap add android || echo "Android already added"

      # ğŸ”„ Ã‰tape 7 - Synchroniser le projet
      - name: Sync Capacitor
        run: npx cap sync android

      # ğŸ§© Ã‰tape 8 - Installer le JDK 17 proprement
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ğŸ” Ã‰tape 9 - GÃ©nÃ©rer un keystore temporaire
      - name: Generate Keystore
        run: |
          keytool -genkeypair -v \
            -keystore my-release-key.jks \
            -alias kingmenu_key \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass kingpass \
            -keypass kingpass \
            -dname "CN=KingMenu, OU=App, O=KingMenu, L=Paris, S=IDF, C=FR"

      # ğŸ§± Ã‰tape 10 - Construire lâ€™APK et le AAB
      - name: Build Android APK & AAB
        working-directory: android
        run: |
          ./gradlew assembleRelease
          ./gradlew bundleRelease

      # ğŸ“¦ Ã‰tape 11 - Signer les fichiers gÃ©nÃ©rÃ©s
      - name: Sign APK & AAB
        run: |
          for file in $(find android/app/build/outputs -name "*.apk" -or -name "*.aab"); do
            jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
              -keystore my-release-key.jks \
              -storepass kingpass \
              -keypass kingpass \
              "$file" kingmenu_key
          done

      # ğŸ“¤ Ã‰tape 12 - Sauvegarder les fichiers gÃ©nÃ©rÃ©s
      - name: Upload APK & AAB
        uses: actions/upload-artifact@v4
        with:
          name: kingmenu-android-builds
          path: |
            android/app/build/outputs/**/*.apk
            android/app/build/outputs/**/*.aab
